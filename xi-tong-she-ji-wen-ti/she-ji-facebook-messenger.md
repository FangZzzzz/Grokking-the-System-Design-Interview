# 设计 Facebook Messenger

## 设计 Facebook Messenger

\
让我们设计一个像Facebook Messenger这样的即时消息服务，用户可以用过Web和移动界面相互发送文本信息。



### 1、什么是 Facebook Messenger

Facebook Messenger是一款向用户提供基于文本的即时消息服务的软件应用程序。Messenger用户可以通过手机和Facebook的网站与他们的Facebook朋友聊天。



### 2、系统的要求和目标

我们的Messenger应满足以下要求：

#### 功能要求

1. Messenger 应该支持用户之间的一对一对话。
2. Messenger 应跟踪其用户的在线/离线状态。
3. Messenger 应支持聊天记录的持久存储。

#### 非功能性要求

1. 用户应该以最小的延迟获得实时聊天体验。
2. 我们的系统应该是高度一致的；用户应该能够在所有设备上看到相同的聊天记录。
3. Messenger 的高可用性是可选的；为了一致性，我们可以容忍较低的可用性。

#### 扩展要求

* 群聊：Messenger应该支持多人在一个群组中相互交谈。
* 推送通知：Messenger应该能够在用户离线时通知用户新消息。



### 3、容量估计和约束

假设我们每天有5亿活跃用户，平均每隔用户每天发送40条消息；这每天给我们带来200亿条消息。

**存储估计：**假设一条消息平均为100bytes，因此要存储一天所有的消息，我们需要2TB的存储空间。

```
200 亿条消息 * 100 bytes => 2 TB/天
```

要存储五年的聊天记录，我们需要3.6PB的存储空间。

```
2 TB * 365 天 * 5 年 ~= 3.6 PB
```

除了聊天消息，我们还需要存储用户信息、消息元数据（ID、时间戳等）。更何况上面的计算没有考虑数据压缩和复制。

**带宽估计**：如果我们的服务每天获取2TB的数据，这讲为我们提供每秒25MB的传入数据。

```
2 TB / 86400 秒 ~= 25 MB/秒
```

由于每条传入消息都需要发送给另一个用户，因此上传和下载都需要25MB/s的相同带宽。



